DROP TABLE DISTRIBUCION;
DROP TABLE VENTAS;
DROP TABLE CLIENTES;
DROP TABLE CONCESIONARIOS;
DROP TABLE COCHES;
DROP TABLE MARCAS;


CREATE TABLE MARCAS (
cifm varchar2(4),
nombre varchar2(10),
ciudad varchar2(10),
CONSTRAINT PK_MARCAS PRIMARY KEY (cifm)
);

INSERT INTO MARCAS
VALUES('0001', 'seat', 'Madrid');
INSERT INTO MARCAS
VALUES('0002', 'renault', 'Barcelona');
INSERT INTO MARCAS
VALUES('0003', 'citroen', 'Valencia');
INSERT INTO MARCAS
VALUES('0004', 'audi', 'Madrid');
INSERT INTO MARCAS
VALUES('0005', 'opel', 'Bilbao');
INSERT INTO MARCAS
VALUES('0006', 'bmw', 'Barcelona');

CREATE TABLE CLIENTES (
dni varchar2(4),
nombre varchar2(10),
apellido varchar2(10),
ciudad varchar2(15),
CONSTRAINT PK_CLIENTES PRIMARY KEY (dni),
CONSTRAINT INITCAP_NOMBRE CHECK (nombre = INITCAP (nombre)),
CONSTRAINT INITCAP_APELLIDO CHECK (apellido = INITCAP (apellido))
);

INSERT INTO CLIENTES
VALUES('0001', 'Luis', 'Garcia', 'Madrid');
INSERT INTO CLIENTES
VALUES('0002', 'Antonio', 'Lopez', 'Valencia');
INSERT INTO CLIENTES
VALUES('0003', 'Juan', 'Martin', 'Madrid');
INSERT INTO CLIENTES
VALUES('0004', 'Maria', 'Garcia', 'Madrid');
INSERT INTO CLIENTES
VALUES('0005', 'Javier', 'Gonzalez', 'Barcelona');
INSERT INTO CLIENTES
VALUES('0006', 'Ana', 'Lopez', 'Barcelona');
INSERT INTO CLIENTES
VALUES('0007', 'Ana', 'Lopez', 'Madrid');
INSERT INTO CLIENTES
VALUES('0008', 'Ana', 'Lopez', 'Barcelona');

CREATE TABLE CONCESIONARIOS (
cifc varchar2(4),
nombre varchar(4),
ciudad varchar2(15),
CONSTRAINT PK_CONCESIONARIOS PRIMARY KEY (cifc),
CONSTRAINT CIUDAD_CLM CHECK (ciudad in('Cuenca', 'Guadalajara', 'Toledo', 'Ciudad Real', 'Albacete'))
);

INSERT INTO CONCESIONARIOS
VALUES('0001', 'acar', 'Cuenca');
INSERT INTO CONCESIONARIOS
VALUES('0002', 'bcar', 'Albacete');
INSERT INTO CONCESIONARIOS
VALUES('0003', 'ccar', 'Albacete');
INSERT INTO CONCESIONARIOS
VALUES('0004', 'dcar', 'Guadalajara');
INSERT INTO CONCESIONARIOS
VALUES('0005', 'ecar', 'Toledo');

CREATE TABLE COCHES (
codcoche varchar2(4),
nombre varchar2(10),
modelo varchar2(10),
cifm varchar2(4),
CONSTRAINT PK_COCHES PRIMARY KEY (codcoche),
CONSTRAINT FK_CIFM_COCHES FOREIGN KEY (cifm) REFERENCES MARCAS(cifm)
);

INSERT INTO COCHES
VALUES('0001', 'ibiza', 'glx', '0001');
INSERT INTO COCHES
VALUES('0002', 'ibiza', 'gti', '0001');
INSERT INTO COCHES
VALUES('0003', 'ibiza', 'gtd', '0001');
INSERT INTO COCHES
VALUES('0004', 'toledo', 'gtd', '0001');
INSERT INTO COCHES
VALUES('0005', 'cordoba', 'gti', '0002');
INSERT INTO COCHES
VALUES('0006', 'megane', '1.6', '0002');
INSERT INTO COCHES
VALUES('0007', 'megane', 'gti', '0002');
INSERT INTO COCHES
VALUES('0008', 'laguna', 'gtd', '0002');
INSERT INTO COCHES
VALUES('0009', 'laguna', 'td', '0002');
INSERT INTO COCHES
VALUES('0010', 'zx', '16v', '0003');
INSERT INTO COCHES
VALUES('0011', 'zx', 'td', '0003');
INSERT INTO COCHES
VALUES('0012', 'xantia', 'gtd', '0003');
INSERT INTO COCHES
VALUES('0013', 'a4', '1.8', '0004');
INSERT INTO COCHES
VALUES('0014', 'a4', '2.8', '0004');
INSERT INTO COCHES
VALUES('0015', 'astra', 'caravan', '0005');
INSERT INTO COCHES
VALUES('0016', 'astra', 'gti', '0005');
INSERT INTO COCHES
VALUES('0017', 'corsa', '1.4', '0005');

CREATE TABLE DISTRIBUCION (
cifc varchar2(4),
codcoche varchar2(4),
cantidad varchar2(2),
CONSTRAINT FK_CIFC_DISTRIBUCION FOREIGN KEY (cifc) REFERENCES CONCESIONARIOS(cifc),
CONSTRAINT FK_CODCOCHE_DISTRIBUCION FOREIGN KEY (codcoche) REFERENCES COCHES(codcoche),
CONSTRAINT CANTIDAD_MAX10 CHECK (cantidad BETWEEN 0 AND 10)
);

INSERT INTO DISTRIBUCION
VALUES('0001', '0001', '3');
INSERT INTO DISTRIBUCION
VALUES('0001', '0005', '7');
INSERT INTO DISTRIBUCION
VALUES('0001', '0006', '7');
INSERT INTO DISTRIBUCION
VALUES('0002', '0006', '5');
INSERT INTO DISTRIBUCION
VALUES('0002', '0008', '10');
INSERT INTO DISTRIBUCION
VALUES('0002', '0009', '10');
INSERT INTO DISTRIBUCION
VALUES('0003', '0010', '5');
INSERT INTO DISTRIBUCION
VALUES('0003', '0011', '3');
INSERT INTO DISTRIBUCION
VALUES('0003', '0012', '5');
INSERT INTO DISTRIBUCION
VALUES('0004', '0013', '10');
INSERT INTO DISTRIBUCION
VALUES('0004', '0014', '5');

CREATE TABLE VENTAS (
cifc varchar2(4),
dni varchar2(4),
codcoche varchar2(4),
color varchar2(10),
CONSTRAINT COLORES CHECK (color in('blanco', 'rojo', 'verde', 'azul')),
constraint COLORES_ACAR CHECK ((cifc != 0001) OR ((cifc = 0001) and (color in ('blanco' , 'rojo')))),
CONSTRAINT FK_CIFC_VENTAS FOREIGN KEY (cifc) REFERENCES CONCESIONARIOS(cifc),
CONSTRAINT FK_DNI_VENTAS FOREIGN KEY (dni) REFERENCES CLIENTES(dni),
CONSTRAINT FK_CODCOCHE_VENTAS FOREIGN KEY (codcoche) REFERENCES COCHES(codcoche)
);

INSERT INTO VENTAS
VALUES('0001', '0001', '0001', 'blanco');
INSERT INTO VENTAS
VALUES('0001', '0002', '0005', 'rojo');
INSERT INTO VENTAS
VALUES('0002', '0003', '0008', 'blanco');
INSERT INTO VENTAS
VALUES('0002', '0001', '0006', 'rojo');
INSERT INTO VENTAS
VALUES('0003', '0004', '0011', 'rojo');
INSERT INTO VENTAS
VALUES('0004', '0005', '0014', 'verde');
INSERT INTO VENTAS
VALUES('0004', '0005', '0013', 'azul');
INSERT INTO VENTAS
VALUES('0004', '0004', '0014', 'verde');


CREATE OR REPLACE VIEW distribuciones
AS SELECT c.nombre, c.modelo, COUNT(cifc)"CONCESIONARIOS"
FROM COCHES C, MARCAS M, CONCESIONARIOS CO
GROUP BY c.nombre, c.modelo;